# ADBTools 自动打包说明

## 概述

本工具提供了一个自动化的打包流程，将 ADBTools 项目打包成 Windows 安装包。整个流程包括：

1. 版本号更新
2. ADB 工具文件路径配置（支持三种方式）
3. Nuitka 构建（单文件可执行程序）
4. 复制 ADB 工具文件和配置文件
5. Inno Setup 打包成安装程序

**最新更新**：现在支持灵活的 ADB 工具文件路径配置，用户可以选择手动输入路径、使用默认路径或跳过复制后手动处理。

## 系统要求

### 必需软件
1. **Python 3.7+** - 项目运行环境
2. **Nuitka** - Python 打包工具（已包含在 requirements_nuitka.txt 中）
3. **Inno Setup 6+** - Windows 安装包制作工具

### 可选软件
- **Git** - 版本控制（如果从 GitHub 克隆项目）

## 安装依赖

```bash
# 创建虚拟环境（推荐）
python -m venv .venv

# 激活虚拟环境
# Windows:
.venv\Scripts\activate

# 安装依赖
pip install -r requirements_nuitka.txt
```

## 文件结构说明

```
ADBTools/
├── auto_package.py          # 自动打包脚本（新创建）
├── nuitka_build.py          # Nuitka 构建脚本
├── ADBTools_setup.iss       # Inno Setup 安装脚本
├── config_manager.py        # 配置文件管理器
├── adbtools_config.json     # 配置文件
├── adbtool.ui              # UI 文件
├── icon.ico                # 程序图标
├── build_nuitka/           # Nuitka 构建输出目录
├── dist_nuitka/            # Nuitka 分发目录
├── Output/                 # Inno Setup 输出目录
└── Function_Moudle/        # 功能模块目录
```

## 使用步骤

### 方法一：使用自动打包脚本（推荐）

```bash
# 运行自动打包脚本
python auto_package.py
```

脚本将引导您完成以下步骤：

1. **输入版本号** - 如：1.6.2
2. **选择 ADB 工具文件来源** - 提供三种选项：
   - 手动输入 platform-tools 文件夹路径
   - 使用默认路径 (D:\work_tools\platform-tools)
   - 跳过 ADB 文件复制（后续手动复制）
3. **自动更新版本号** - 更新 config_manager.py 和 ADBTools_setup.iss
4. **执行 Nuitka 构建** - 生成单文件可执行程序
5. **复制文件到构建目录** - 根据选择复制 ADB 工具文件和配置文件
6. **Inno Setup 打包** - 生成安装包 ADBTools_Setup.exe

### 方法二：手动打包步骤

如果您需要更多控制，可以手动执行各个步骤：

```bash
# 1. 更新版本号（手动编辑文件）
# 编辑 config_manager.py 中的 DEFAULT_CONFIG["version"]
# 编辑 ADBTools_setup.iss 中的 #define MyAppVersion

# 2. 执行 Nuitka 构建
python nuitka_build.py --build onefile

# 3. 复制 ADB 工具文件（手动复制）
# 将 platform-tools 文件夹中的所有文件复制到 build_nuitka\
# 必需的 ADB 文件包括：adb.exe, AdbWinApi.dll, AdbWinUsbApi.dll

# 4. 复制配置文件（手动复制）
# 将 adbtool.ui 和 adbtools_config.json 复制到 build_nuitka\

# 5. 运行 Inno Setup
iscc ADBTools_setup.iss
```

## 配置说明

### 版本号格式
- 格式：`主版本.次版本.修订号`（如：1.6.2）
- 示例：1.6.2 → 主版本=1, 次版本=6, 修订号=2

### ADB 工具文件路径配置
打包时提供三种 ADB 工具文件处理方式：

1. **手动输入路径** - 运行时输入 platform-tools 文件夹路径
2. **使用默认路径** - 使用预设的 `D:\work_tools\platform-tools` 路径
3. **跳过复制** - 不复制 ADB 文件，打包后手动复制

默认路径可以在 `auto_package.py` 的 `get_user_inputs()` 函数中修改：

```python
default_path = Path(r"D:\work_tools\platform-tools")
```

### 需要复制的文件
默认复制以下文件到 build_nuitka 目录：
- adbtool.ui
- adbtools_config.json
- icon.ico

## 常见问题

### 1. iscc 命令未找到
**问题**：运行 Inno Setup 时提示 "iscc 命令未找到"
**解决**：
- 确保已安装 Inno Setup 6+
- 将 Inno Setup 安装目录添加到系统 PATH
- 或修改 auto_package.py 中的 iscc 路径

### 2. Nuitka 构建失败
**问题**：Nuitka 构建过程中出现错误
**解决**：
- 检查 Python 依赖是否完整安装
- 运行 `python nuitka_build.py --check` 检查依赖
- 确保有足够的磁盘空间

### 3. 版本号更新失败
**问题**：版本号未正确更新
**解决**：
- 检查版本号格式是否正确
- 确保有文件写入权限
- 手动检查 config_manager.py 和 ADBTools_setup.iss 文件

### 4. 文件复制失败
**问题**：platform-tools 文件复制失败
**解决**：
- 检查输入的 platform-tools 路径是否正确
- 确保路径存在且有读取权限
- 可以尝试使用默认路径或选择跳过复制后手动复制
- 必需的 ADB 文件：adb.exe, AdbWinApi.dll, AdbWinUsbApi.dll

### 5. ADB 文件选择问题
**问题**：不知道应该选择哪种 ADB 文件处理方式
**解决**：
- 如果有完整的 platform-tools 文件夹，选择手动输入路径
- 如果经常使用 `D:\work_tools\platform-tools`，选择使用默认路径
- 如果 ADB 文件在其他位置或需要特殊版本，选择跳过复制后手动复制
- 跳过复制后，需要手动将 adb.exe, AdbWinApi.dll, AdbWinUsbApi.dll 复制到 build_nuitka 目录

## 输出文件

打包完成后，生成的文件位于：

1. **build_nuitka/** - Nuitka 构建的中间文件
2. **dist_nuitka/** - Nuitka 生成的可执行文件和相关文件
3. **Output/** - Inno Setup 生成的安装包
   - `ADBTools_Setup.exe` - 最终安装程序

## 自定义配置

### 修改安装脚本
编辑 `ADBTools_setup.iss` 文件可以自定义：
- 安装程序名称和版本
- 公司信息和网址
- 安装目录和快捷方式
- 包含的文件列表

### 修改打包脚本
编辑 `auto_package.py` 可以自定义：
- 默认 ADB 工具文件路径
- ADB 文件处理选项
- 需要复制的文件列表
- 构建和输出目录
- 清理选项

## 注意事项

1. **备份重要文件**：打包前建议备份 config_manager.py 等重要文件
2. **测试安装包**：生成安装包后，建议在测试环境中安装测试
3. **版本控制**：建议使用 Git 管理代码，打包前提交更改
4. **磁盘空间**：确保有足够的磁盘空间（约 500MB-1GB）

## 联系支持

如有问题，请参考：
- 项目文档：README.md
- 代码仓库：https://github.com/wangke956/ADBTools.git
- 问题反馈：创建 GitHub Issue