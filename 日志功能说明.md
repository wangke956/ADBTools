# ADBTools 日志功能说明

## 概述

ADBTools 现在配备了完整的日志记录系统，可以详细记录每次操作的详细信息，包括：
- 应用启动和关闭
- 设备连接和刷新
- ADB 命令执行
- 应用安装、卸载、启动等操作
- 错误和异常信息
- 操作性能统计
- 用户操作历史

## 日志文件位置

默认情况下，所有日志文件都存储在 `logs/` 目录下：

```
ADBTools/
├── logs/
│   ├── adbtools.log              # 主日志文件
│   ├── operation_history.log     # 操作历史记录
│   ├── performance.log            # 性能监控日志
│   ├── adbtools.log.1             # 日志轮转备份
│   ├── adbtools.log.2
│   └── ...
```

## 日志配置

日志配置位于 `adbtools_config.json` 文件中：

```json
{
  "logging": {
    "level": "DEBUG",
    "file": "adbtools.log",
    "max_size": 10485760,
    "backup_count": 5,
    "console_output": true,
    "log_dir": "logs",
    "enable_operation_history": true,
    "enable_performance_monitoring": true,
    "format": "detailed",
    "log_adb_commands": true,
    "log_thread_operations": true,
    "log_user_actions": true,
    "log_errors": true,
    "log_warnings": true,
    "log_debug_info": true
  }
}
```

### 配置说明

- **level**: 日志级别，可选值：
  - `DEBUG`: 最详细的日志，包括所有调试信息
  - `INFO`: 一般信息日志
  - `WARNING`: 警告信息
  - `ERROR`: 错误信息
  - `CRITICAL`: 严重错误

- **file**: 主日志文件名

- **max_size**: 单个日志文件的最大大小（字节），默认 10MB

- **backup_count**: 保留的备份文件数量

- **console_output**: 是否在控制台输出日志

- **log_dir**: 日志文件存储目录

- **enable_operation_history**: 是否启用操作历史记录

- **enable_performance_monitoring**: 是否启用性能监控

- **format**: 日志格式，可选值：
  - `simple`: 简单格式
  - `detailed`: 详细格式（推荐）
  - `verbose`: 最详细格式

## 日志内容

### 主日志文件 (adbtools.log)

记录所有详细的系统日志，包括：
- 应用启动和关闭
- 设备连接状态
- ADB 命令执行
- 线程操作
- 错误和异常

示例日志格式：
```
2026-01-16 10:30:45 - ADBTools.Main - INFO - [main.py:30] - [main] - ADBTools 应用程序启动
2026-01-16 10:30:45 - ADBTools.Main - INFO - [main.py:31] - [main] - Python 版本: 3.10.16
2026-01-16 10:30:45 - ADBTools.ADB_Module - INFO - [ADB_module.py:100] - [__init__] - 初始化 ADB 主窗口...
2026-01-16 10:30:46 - ADBTools.ADB_Utils - INFO - [adb_utils.py:50] - [get_adb_path] - 找到ADB (绝对路径): D:\adb.exe
2026-01-16 10:30:47 - ADBTools.ADB_Utils - DEBUG - [adb_utils.py:100] - [run_adb_command] - 执行ADB命令 [无设备]: devices
2026-01-16 10:30:48 - ADBTools.RefreshDevicesThread - INFO - [refresh_devices_thread.py:40] - [run] - 找到 1 个设备: 12345678
```

### 操作历史记录 (operation_history.log)

记录所有用户操作的详细历史，以 JSON 格式存储：

```json
{
  "timestamp": "2026-01-16 10:30:50",
  "operation_type": "refresh_devices",
  "device_id": null,
  "details": {
    "action": "刷新设备列表"
  },
  "result": "success",
  "thread_id": 12345,
  "thread_name": "RefreshDevicesThread"
}
```

### 性能监控日志 (performance.log)

记录每个操作的执行时间，用于性能分析：

```json
{
  "timestamp": "2026-01-16 10:30:50",
  "operation": "refresh_devices",
  "device_id": null,
  "elapsed_time": 1.234,
  "thread_id": 12345
}
```

## 日志查看工具

### 命令行工具

提供了 `log_viewer.py` 命令行工具来查看和分析日志：

```bash
# 查看日志摘要
python log_viewer.py --view

# 导出日志到文件（文本格式）
python log_viewer.py --export logs_export.txt

# 导出日志到文件（JSON格式）
python log_viewer.py --export logs_export.json --type json

# 在日志文件中搜索关键词
python log_viewer.py --search "ERROR" --file logs/adbtools.log
```

### 程序内查看

可以通过以下代码在程序内查看日志：

```python
from log_viewer import LogViewer

# 创建日志查看器
viewer = LogViewer()

# 获取所有日志文件
log_files = viewer.get_log_files()

# 读取日志文件
lines = viewer.read_log_file("logs/adbtools.log")

# 搜索日志
results = viewer.search_logs("logs/adbtools.log", "ERROR")

# 获取操作历史
operations = viewer.get_operation_history(100)

# 获取性能统计
stats = viewer.get_performance_statistics()

# 打印摘要
viewer.print_summary()

# 导出日志
viewer.export_logs("export.txt", "txt")

# 清空日志
viewer.clear_logs()
```

## 在代码中使用日志

### 导入日志记录器

```python
from logger_manager import get_logger, log_operation, measure_performance, log_exception

# 创建日志记录器
logger = get_logger("YourModuleName")
```

### 记录不同级别的日志

```python
# DEBUG 级别 - 详细的调试信息
logger.debug("调试信息")

# INFO 级别 - 一般信息
logger.info("操作成功")

# WARNING 级别 - 警告信息
logger.warning("警告信息")

# ERROR 级别 - 错误信息
logger.error("操作失败")

# CRITICAL 级别 - 严重错误
logger.critical("严重错误")
```

### 记录操作历史

```python
log_operation(
    operation_type="install_apk",
    details={"package_name": "com.example.app", "version": "1.0"},
    device_id="12345678",
    result="success"
)
```

### 性能监控

```python
# 使用上下文管理器测量操作耗时
with measure_performance("install_apk", device_id="12345678"):
    # 执行操作
    install_app("com.example.app")
```

### 记录异常

```python
try:
    # 可能出错的操作
    result = do_something()
except Exception as e:
    # 记录异常详情
    log_exception(logger, "do_something", e, device_id="12345678")
```

### 在线程中使用日志

```python
from Function_Moudle.thread_logger import get_thread_logger, log_thread_operation

class MyThread(QThread):
    def __init__(self, device_id):
        super().__init__()
        self.device_id = device_id
        self.logger = get_thread_logger("MyThread")
        self.logger.info(f"线程初始化: {device_id}")
    
    @log_thread_operation("my_operation", device_id=None)
    def run(self):
        # 线程主要逻辑
        self.logger.info("开始执行操作")
        # ...
        self.logger.info("操作完成")
```

## 日志轮转

当日志文件达到最大大小时，会自动进行轮转：

1. 当前日志文件重命名为 `adbtools.log.1`
2. 旧的 `adbtools.log.1` 重命名为 `adbtools.log.2`
3. 依此类推
4. 超过 `backup_count` 的旧文件会被删除

## 故障排查

### 日志文件过大

如果日志文件过大，可以：
1. 减少 `max_size` 配置值
2. 减少 `backup_count` 配置值
3. 将日志级别从 `DEBUG` 改为 `INFO`
4. 定期清理日志文件

### 日志文件位置

如果找不到日志文件，检查：
1. `log_dir` 配置是否正确
2. 应用程序是否有写入权限
3. 是否在打包后的 exe 目录下

### 性能影响

如果日志记录影响性能，可以：
1. 将日志级别改为 `INFO` 或更高
2. 关闭 `enable_performance_monitoring`
3. 关闭 `enable_operation_history`
4. 关闭 `console_output`

## 最佳实践

1. **合理设置日志级别**：开发环境使用 `DEBUG`，生产环境使用 `INFO`
2. **记录关键操作**：所有用户操作都应该记录到操作历史
3. **监控性能**：对耗时操作使用性能监控
4. **记录异常**：所有异常都应该完整记录，包括堆栈信息
5. **定期清理**：定期清理旧日志文件，避免占用过多磁盘空间
6. **敏感信息**：避免在日志中记录敏感信息（如密码、密钥等）

## 技术支持

如有问题或建议，请通过以下方式联系：
- GitHub Issues: https://github.com/wangke956/ADBTools/issues
- 查看日志文件获取详细的错误信息